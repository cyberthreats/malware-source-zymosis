; ============================================================================
;	реализация лога
; 	last change :: 24.10.2007
; ============================================================================

include		log.inc

; ============================================================================================	
;  in		:  
;  out		:  
;  actions	:  
;  changes	:  
open_log_files proc
		local		result:dword

		pushad

		mov			result, 0

		mov			[offset log.overlay + ebx], 0
		mov			[offset log.small_size + ebx], 0		
		mov			[offset log.large_size + ebx], 0
		mov			[offset log.null_last_section + ebx], 0
		mov			[offset log.cheksum_not_null + ebx], 0
		mov			[offset log.open_errors + ebx], 0
		mov			[offset log.ep_not_found + ebx], 0
		mov			[offset log.x64 + ebx], 0
		mov			[offset log.not_pe + ebx], 0
		mov			[offset log.total_to_infect + ebx], 0
		mov			[offset log.total + ebx], 0
		
		push		0								; hTemplateFile
		push		FILE_ATTRIBUTE_NORMAL			; dwFlagsAndAttributes
		push		CREATE_ALWAYS					; dwCreationDisposition
		push		0								; lpSecurityAttributes 
		push		FILE_SHARE_READ					; dwShareMode
		push		GENERIC_WRITE					; dwDesiredAccess
		lea			eax, sz_overlay
		add			eax, ebx
		push		eax
		ke32_call	CreateFileA
		cmp			eax, INVALID_HANDLE_VALUE		
		je			__open_log_files_end
		mov			[offset log.h_overlay + ebx], eax
		
		push		0								; hTemplateFile
		push		FILE_ATTRIBUTE_NORMAL			; dwFlagsAndAttributes
		push		CREATE_ALWAYS					; dwCreationDisposition
		push		0								; lpSecurityAttributes 
		push		FILE_SHARE_READ					; dwShareMode
		push		GENERIC_WRITE					; dwDesiredAccess
		lea			eax, sz_file_small
		add			eax, ebx
		push		eax
		ke32_call	CreateFileA
		cmp			eax, INVALID_HANDLE_VALUE		
		je			__open_log_files_end		
		mov			[offset log.h_small_size + ebx], eax
		
		push		0								; hTemplateFile
		push		FILE_ATTRIBUTE_NORMAL			; dwFlagsAndAttributes
		push		CREATE_ALWAYS					; dwCreationDisposition
		push		0								; lpSecurityAttributes 
		push		FILE_SHARE_READ					; dwShareMode
		push		GENERIC_WRITE					; dwDesiredAccess
		lea			eax, sz_file_big
		add			eax, ebx
		push		eax
		ke32_call	CreateFileA
		cmp			eax, INVALID_HANDLE_VALUE		
		je			__open_log_files_end		
		mov			[offset log.h_large_size + ebx], eax
		
		push		0								; hTemplateFile
		push		FILE_ATTRIBUTE_NORMAL			; dwFlagsAndAttributes
		push		CREATE_ALWAYS					; dwCreationDisposition
		push		0								; lpSecurityAttributes 
		push		FILE_SHARE_READ					; dwShareMode
		push		GENERIC_WRITE					; dwDesiredAccess
		lea			eax, sz_null_last_section
		add			eax, ebx
		push		eax
		ke32_call	CreateFileA
		cmp			eax, INVALID_HANDLE_VALUE		
		je			__open_log_files_end		
		mov			[offset log.h_null_last_section + ebx], eax

		push		0								; hTemplateFile
		push		FILE_ATTRIBUTE_NORMAL			; dwFlagsAndAttributes
		push		CREATE_ALWAYS					; dwCreationDisposition
		push		0								; lpSecurityAttributes 
		push		FILE_SHARE_READ					; dwShareMode
		push		GENERIC_WRITE					; dwDesiredAccess
		lea			eax, sz_cheksum
		add			eax, ebx
		push		eax
		ke32_call	CreateFileA
		cmp			eax, INVALID_HANDLE_VALUE		
		je			__open_log_files_end		
		mov			[offset log.h_cheksum_not_null + ebx], eax
		
		push		0								; hTemplateFile
		push		FILE_ATTRIBUTE_NORMAL			; dwFlagsAndAttributes
		push		CREATE_ALWAYS					; dwCreationDisposition
		push		0								; lpSecurityAttributes 
		push		FILE_SHARE_READ					; dwShareMode
		push		GENERIC_WRITE					; dwDesiredAccess
		lea			eax, sz_open_error
		add			eax, ebx
		push		eax
		ke32_call	CreateFileA
		cmp			eax, INVALID_HANDLE_VALUE		
		je			__open_log_files_end		
		mov			[offset log.h_open_errors + ebx], eax
		
		push		0								; hTemplateFile
		push		FILE_ATTRIBUTE_NORMAL			; dwFlagsAndAttributes
		push		CREATE_ALWAYS					; dwCreationDisposition
		push		0								; lpSecurityAttributes 
		push		FILE_SHARE_READ					; dwShareMode
		push		GENERIC_WRITE					; dwDesiredAccess
		lea			eax, sz_ep_not_found
		add			eax, ebx
		push		eax
		ke32_call	CreateFileA
		cmp			eax, INVALID_HANDLE_VALUE		
		je			__open_log_files_end		
		mov			[offset log.h_ep_not_found + ebx], eax

		push		0								; hTemplateFile
		push		FILE_ATTRIBUTE_NORMAL			; dwFlagsAndAttributes
		push		CREATE_ALWAYS					; dwCreationDisposition
		push		0								; lpSecurityAttributes 
		push		FILE_SHARE_READ					; dwShareMode
		push		GENERIC_WRITE					; dwDesiredAccess
		lea			eax, sz_x64
		add			eax, ebx
		push		eax
		ke32_call	CreateFileA
		cmp			eax, INVALID_HANDLE_VALUE		
		je			__open_log_files_end		
		mov			[offset log.h_x64 + ebx], eax

		push		0								; hTemplateFile
		push		FILE_ATTRIBUTE_NORMAL			; dwFlagsAndAttributes
		push		CREATE_ALWAYS					; dwCreationDisposition
		push		0								; lpSecurityAttributes 
		push		FILE_SHARE_READ					; dwShareMode
		push		GENERIC_WRITE					; dwDesiredAccess
		lea			eax, sz_not_pe
		add			eax, ebx
		push		eax
		ke32_call	CreateFileA
		cmp			eax, INVALID_HANDLE_VALUE		
		je			__open_log_files_end		
		mov			[offset log.h_not_pe + ebx], eax
		
		push		0								; hTemplateFile
		push		FILE_ATTRIBUTE_NORMAL			; dwFlagsAndAttributes
		push		CREATE_ALWAYS					; dwCreationDisposition
		push		0								; lpSecurityAttributes 
		push		FILE_SHARE_READ					; dwShareMode
		push		GENERIC_WRITE					; dwDesiredAccess
		lea			eax, sz_success
		add			eax, ebx
		push		eax
		ke32_call	CreateFileA
		cmp			eax, INVALID_HANDLE_VALUE		
		je			__open_log_files_end		
		mov			[offset log.h_total_to_infect + ebx], eax
		
		push		0								; hTemplateFile
		push		FILE_ATTRIBUTE_NORMAL			; dwFlagsAndAttributes
		push		CREATE_ALWAYS					; dwCreationDisposition
		push		0								; lpSecurityAttributes 
		push		FILE_SHARE_READ					; dwShareMode
		push		GENERIC_WRITE					; dwDesiredAccess
		lea			eax, sz_total
		add			eax, ebx
		push		eax
		ke32_call	CreateFileA
		cmp			eax, INVALID_HANDLE_VALUE		
		je			__open_log_files_end		
		mov			[offset log.h_total + ebx], eax
		
		mov			result, 1
		
__open_log_files_end:
		popad
		mov		eax, result
		ret
open_log_files endp	
; ============================================================================================	




; ============================================================================================	
;  in		:  
;  out		:  
;  actions	:  
;  changes	:  
close_log_files proc
		LOCAL 		buff[20]:BYTE
		local		bytes_rw:dword
		pushad

		push		[offset log.overlay + ebx]
		lea			eax, sz_template
		add			eax, ebx
		push		eax
		lea			eax, buff
		push		eax
		user32_call	_wsprintfA
		pop			eax
		pop			eax
		pop			eax
		lea			eax, buff
		push		eax
		call		str_len
		mov			edx, eax
		write_file	[offset log.h_overlay + ebx], buff, edx, bytes_rw
		push		[offset log.h_overlay + ebx]
		ke32_call	CloseHandle
		
		
		
		push		[offset log.small_size + ebx]
		lea			eax, sz_template
		add			eax, ebx
		push		eax
		lea			eax, buff
		push		eax
		user32_call	_wsprintfA
		pop			eax
		pop			eax
		pop			eax
		lea			eax, buff
		push		eax
		call		str_len
		mov			edx, eax
		write_file	[offset log.h_small_size + ebx], buff, edx, bytes_rw
		push		[offset log.h_small_size + ebx]
		ke32_call	CloseHandle

		

		push		[offset log.large_size + ebx]
		lea			eax, sz_template
		add			eax, ebx
		push		eax
		lea			eax, buff
		push		eax
		user32_call	_wsprintfA
		pop			eax
		pop			eax
		pop			eax
		lea			eax, buff
		push		eax
		call		str_len
		mov			edx, eax
		write_file	[offset log.h_large_size + ebx], buff, edx, bytes_rw
		push		[offset log.h_large_size + ebx]
		ke32_call	CloseHandle

		
		push		[offset log.null_last_section + ebx]
		lea			eax, sz_template
		add			eax, ebx
		push		eax
		lea			eax, buff
		push		eax
		user32_call	_wsprintfA
		pop			eax
		pop			eax
		pop			eax
		lea			eax, buff
		push		eax
		call		str_len
		mov			edx, eax
		write_file	[offset log.h_null_last_section + ebx], buff, edx, bytes_rw		
		push		[offset log.h_null_last_section + ebx]
		ke32_call	CloseHandle

		
		push		[offset log.cheksum_not_null + ebx]
		lea			eax, sz_template
		add			eax, ebx
		push		eax
		lea			eax, buff
		push		eax
		user32_call	_wsprintfA
		pop			eax
		pop			eax
		pop			eax
		lea			eax, buff
		push		eax
		call		str_len
		mov			edx, eax
		write_file	[offset log.h_cheksum_not_null + ebx], buff, edx, bytes_rw				
		push		[offset log.h_cheksum_not_null + ebx]
		ke32_call	CloseHandle

		
		push		[offset log.open_errors + ebx]
		lea			eax, sz_template
		add			eax, ebx
		push		eax
		lea			eax, buff
		push		eax
		user32_call	_wsprintfA
		pop			eax
		pop			eax
		pop			eax
		lea			eax, buff
		push		eax
		call		str_len
		mov			edx, eax
		write_file	[offset log.h_open_errors + ebx], buff, edx, bytes_rw				
		push		[offset log.h_open_errors + ebx]
		ke32_call	CloseHandle

		
		
		push		[offset log.ep_not_found + ebx]
		lea			eax, sz_template
		add			eax, ebx
		push		eax
		lea			eax, buff
		push		eax
		user32_call	_wsprintfA
		pop			eax
		pop			eax
		pop			eax
		lea			eax, buff
		push		eax
		call		str_len
		mov			edx, eax
		write_file	[offset log.h_ep_not_found + ebx], buff, edx, bytes_rw		
		push		[offset log.h_ep_not_found + ebx]
		ke32_call	CloseHandle

		
		push		[offset log.x64 + ebx]
		lea			eax, sz_template
		add			eax, ebx
		push		eax
		lea			eax, buff
		push		eax
		user32_call	_wsprintfA
		pop			eax
		pop			eax
		pop			eax
		lea			eax, buff
		push		eax
		call		str_len
		mov			edx, eax
		write_file	[offset log.h_x64 + ebx], buff, edx, bytes_rw			
		push		[offset log.h_x64 + ebx]
		ke32_call	CloseHandle

		
		
		push		[offset log.not_pe + ebx]
		lea			eax, sz_template
		add			eax, ebx
		push		eax
		lea			eax, buff
		push		eax
		user32_call	_wsprintfA
		pop			eax
		pop			eax
		pop			eax
		lea			eax, buff
		push		eax
		call		str_len
		mov			edx, eax
		write_file	[offset log.h_not_pe + ebx], buff, edx, bytes_rw		
		push		[offset log.h_not_pe + ebx]
		ke32_call	CloseHandle

		
		push		[offset log.total_to_infect + ebx]
		lea			eax, sz_template
		add			eax, ebx
		push		eax
		lea			eax, buff
		push		eax
		user32_call	_wsprintfA
		pop			eax
		pop			eax
		pop			eax
		lea			eax, buff
		push		eax
		call		str_len
		mov			edx, eax
		write_file	[offset log.h_total_to_infect + ebx], buff, edx, bytes_rw		
		push		[offset log.h_total_to_infect + ebx]
		ke32_call	CloseHandle
		
		
		push		[offset log.total + ebx]
		lea			eax, sz_template
		add			eax, ebx
		push		eax
		lea			eax, buff
		push		eax
		user32_call	_wsprintfA
		pop			eax
		pop			eax
		pop			eax
		lea			eax, buff
		push		eax
		call		str_len
		mov			edx, eax
		write_file	[offset log.h_total + ebx], buff, edx, bytes_rw				
		push		[offset log.h_total + ebx]
		ke32_call	CloseHandle		

		
		popad
		ret
close_log_files endp	
; ============================================================================================




; ============================================================================================	
;  in		:  
;  out		:  
;  actions	:  
;  changes	:  
write_log_file proc	file:dword, string:dword
		local		bytes_rw:dword
		pushad
	
		push		NULL			; lpOverlapped
		lea			eax, bytes_rw
		push		eax				; lpNumberOfBytesWritten
		push		string
		call		str_len
		push		eax				; nNumberOfBytesToWrite
		push		string			; lpBuffer
		push		file			; hFile
		ke32_call	WriteFile	

		write_file	file, sz_crlf, 4, bytes_rw

		popad
		ret
write_log_file endp
; ============================================================================================	