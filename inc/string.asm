; ============================================================================
;	string.asm
;
;	функции для работы с ASCIIZ-строками
;	
;
; 	last change :: 14.10.2007
;
;
;		список функций:
;			- str_len (str_addr:DWORD)
;			- str_cpy (from:DWORD, to:DWORD)
;			- add_backslash (str_addr:DWORD)
;			- add_star (str_addr:DWORD)
;			- conc_str (str1:DWORD, str2:DWORD, dest:DWORD)
; ============================================================================



; ============================================================================================
; in			:  str_addr - смещение ASCIIZ-строки, длину которой надо посчитать
; out		:  eax - длина строки без Z-символа
; action		:  считает длину ASCIIZ-строки, на которую указывает параметр str_addr
; changes	:  eax
str_len	proc	str_addr:DWORD
		LOCAL	result:DWORD
		pushad
		
		xor			ecx, ecx
		mov			edi, str_addr
		mov			al, 0
		
__str_len_loop:
		scasb
		jz			__str_len_end
		inc			ecx
		jmp			__str_len_loop

__str_len_end:
		mov			result, ecx
		popad
		mov			eax, result
		ret
str_len	endp
; ============================================================================================





; ============================================================================================	
; in			:  from - указатель на ASCIIZ буфер источник
;			:  to   - указатель на ASCIIZ буфер приёмник (контроль за размерностью буфера возложен на вызывающего)
; out		:  
; action		:  копирует ASCIIZ-строку из буфера from в буфер to
; changes	:  to
str_cpy	proc	from:DWORD, to:DWORD
		pushad
		
		push		from
		call		str_len
		mov			ecx, eax
		
		mov			edi, to
		mov			esi, from
		
		rep			movsb
		
		mov			byte ptr [edi], 0
		
		popad
		ret
str_cpy	endp
; ============================================================================================





; ============================================================================================	
; in			:  str_addr - смещение ASCIIZ-строки, для которой проверяется наличие слеша; 
;			:  длина буфера должна предусматривать возможность вставки слеша
; out		:  входная строка со слешем в конце
; action		:  проверяет, есть ли у переданной строки завершающий слеш
;			:  если нет - добавляет
; changes	:  nothing / переданная строка
add_backslash	proc	str_addr:DWORD
		pushad
		
		mov			edi, str_addr
		
		push		edi
		call		str_len
		
		add			edi, eax
		cmp			byte ptr [edi - 1], '\'
		jz			__add_backslash_end
		mov			byte ptr [edi], '\'
		mov			byte ptr [edi + 1], 0
		
__add_backslash_end:
		popad
		ret
add_backslash	endp
; ============================================================================================





; ============================================================================================	
; in			:  str_addr - смещение ASCIIZ-строки, к которой клеится звёздочка
;			:  длина буфера должна предусматривать возможность вставки звёздочки
; out		:  входная строка со звёздочкой в конце
; action		:  проверяет, есть ли у переданной строки в конце звёздочка
;			:  если нет - добавляет
; changes	:  nothing / переданная строка
add_star	proc	str_addr:DWORD
		pushad
		
		mov			edi, str_addr
		
		push		edi
		call		str_len
		
		add			edi, eax
		cmp			byte ptr [edi - 1], '*'
		jz			__add_star_end
		mov			byte ptr [edi], '*'
		mov			byte ptr [edi + 1], 0
		
__add_star_end:
		popad
		ret
add_star	endp
; ============================================================================================





; ============================================================================================	
; in			:  str1 - смещение первой ASCIIZ-строки
; 			:  str2 - смещение второй ASCIIZ-строки
; 			:  dest - смещение ASCIIZ-строки, куда будет произведено копирование. 
;			          это может быть как отдельная строка, так и str1 или str2 (при достаточной длине буфера)
; out		:  dest - склеенная строка
; action		:  помещает в dest сначала str1, потом str2. копирует через временный локальный буфер на 4 кб
; changes	:  dest
conc_str	proc	str1:DWORD, str2:DWORD, dest:DWORD
		LOCAL	buffer[4*1024]:BYTE
		LOCAL	sz:DWORD
		pushad
		
		mov			esi, str1
		lea			edi, buffer
		push		esi
		call		str_len
		mov			ecx, eax
		mov			sz, ecx
		rep			movsb
		
		mov			esi, str2
		push		esi
		call		str_len
		mov			ecx, eax
		add			sz, ecx
		rep			movsb

		mov			edi, dest
		lea			esi, buffer
		mov			ecx, sz
		rep			movsb
		
		mov			byte ptr [edi], 0

		popad
		ret
conc_str	endp
; ============================================================================================