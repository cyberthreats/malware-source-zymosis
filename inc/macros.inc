; ============================================================================
;	макросы проекта
; 	last change :: 19.10.2007
; ============================================================================


; ============================================================================================	
;  
;  		макрос для вызова kernel32 API-функций с динамическим определением адресов
;		для вызова в ebx должно содержаться дельта-смещение		
;  
ke32_call	macro	func_name
		mov			eax, dword ptr [offset func_name + ebx]		; eax - хэш имени вызываемой из kernel32 функции
		call		get_ke32_function_by_hash					; после вызова     eax = адресу соответствующй хэшу kernel32 api-функции
		call		eax											; вызов api-функции
			endm
; ============================================================================================	




; ============================================================================================	
;  
;  		макрос для вызова ntdll API-функций с динамическим определением адресов
;		для вызова в ebx должно содержаться дельта-смещение		
;  
IF	NTDLL
ntdll_call	macro	func_name
		lea			eax, ntdll
		add			eax, ebx
		push		eax											; смещение строки ASCIIZ "ntdll"
		mov			eax, dword ptr [offset func_name + ebx]		; eax - хэш имени вызываемой из ntdll функции
		call		get_function_by_hash						; после вызова     eax = адресу соответствующй хэшу ntdll api-функции
		call		eax											; вызов api-функции
			endm
ENDIF			
; ============================================================================================	




; ============================================================================================	
;  
;  		макрос для вызова user32 API-функций с динамическим определением адресов
;		для вызова в ebx должно содержаться дельта-смещение		
;  
IF	USER32
user32_call	macro	func_name
		lea			eax, user32
		add			eax, ebx
		push		eax											; смещение строки ASCIIZ "user32"
		mov			eax, dword ptr [offset func_name + ebx]		; eax - хэш имени вызываемой из user32 функции
		call		get_function_by_hash						; после вызова     eax = адресу соответствующй хэшу user32 api-функции
		call		eax											; вызов api-функции
			endm
ENDIF
; ============================================================================================	




; ============================================================================================	
;  
;  		макрос для вызова API-функции ReadFile
;		для вызова в ebx должно содержаться дельта-смещение		
;  
read_file	macro	handle, buffer, n_to_read, n_read
		push		NULL			; lpOverlapped
		lea			eax, n_read
		push		eax				; lpNumberOfBytesRead
		push		n_to_read		; nNumberOfBytesToRead
		lea			eax, buffer
		push		eax				; lpBuffer
		push		handle			; hFile
		ke32_call	ReadFile
			endm
; ============================================================================================	




; ============================================================================================	
;  
;  		макрос для вызова API-функции WriteFile
;		для вызова в ebx должно содержаться дельта-смещение		
;  			
write_file	macro	handle, buffer, n_to_write, n_written
		push		NULL			; lpOverlapped
		lea			eax, n_written
		push		eax				; lpNumberOfBytesWritten
		push		n_to_write		; nNumberOfBytesToWrite
		lea			eax, buffer
		push		eax				; lpBuffer
		push		handle			; hFile
		ke32_call	WriteFile		
			endm
; ============================================================================================	




; ============================================================================================	
;  
;  		макрос для вызова API-функции SetFilePointer
;		для вызова в ebx должно содержаться дельта-смещение		
;  
set_fp	macro	handle, dist, direction
		push		direction		; dwMoveMethod
		push		NULL			; lpDistanceToMoveHigh
		push		dist			; lDistanceToMove
		push		handle			; hFile
		ke32_call	SetFilePointer	
		endm
; ============================================================================================	






; ============================================================================================	
;  
;  		макрос для записи в соответствующий лог-файл соответствующей строки
;		для вызова в ebx должно содержаться дельта-смещение		
;  
IF	STAT
write_log_string	macro	file, string
		push		string
		push		file		
		call		write_log_file
		endm
ENDIF		
; ============================================================================================	







